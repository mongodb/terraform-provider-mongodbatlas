variables:
  - &go_linux_version
    go_root: "/opt/golang/go1.24"
    go_bin: "/opt/golang/go1.24/bin"
    go_base_path: ""
  - &go_windows_version
    go_root: "c:\\golang\\go1.24"
    go_bin: "c:\\golang\\go1.24\\bin"
    go_base_path: "c:"
  - &go_env
    XDG_CONFIG_HOME: ${go_base_path}${workdir}
    GO111MODULE: "on"
    GOROOT: ${go_root}
    GOPATH: ${go_base_path}${workdir}
    ADD_PATH: "${go_bin}:${go_base_path}${workdir}/bin:${go_base_path}${workdir}/src/github.com/mongodb/terraform-provider-mongodbatlas/bin"
  - &go_options
    add_to_path:
      - ${go_bin}
      - ${go_base_path}${workdir}/bin
      - ${go_base_path}${workdir}/src/github.com/mongodb/terraform-provider-mongodbatlas/bin
    include_expansions_in_env:
      - go_base_path
      - workdir
    working_dir: src/github.com/mongodb/terraform-provider-mongodbatlas
    env:
      <<: *go_env
functions:
  "trace artifacts":
    - command: shell.exec
      params:
        working_dir: "src"
        script: |
           tag=$(git describe --tags --always --dirty)

           # remove the leading 'r'
           version2=$(echo -n "test-$tag" | cut -c 2-)

           cat <<EOT > trace-expansions.yml
           release_version: "$version2"
           EOT
           cat trace-expansions.yml
        # working_dir: src/github.com/mongodb/terraform-provider-mongodbatlas
        # include_expansions_in_env: true
        # script: |
        #   product="terraform-provider-mongodbatlas"

        #   cat <<EOT > src/github.com/mongodb/terraform-provider-mongodbatlas/expansions.yaml
        #   product: "test-$product"
        #   EOT
    # - command: expansions.update
    #   params:
    #     ignore_missing_file: true
    #     file: src/github.com/mongodb/terraform-provider-mongodbatlas/expansions.yaml
    - command: expansions.update
      params:
        file: src/trace-expansions.yml
    - command: papertrail.trace
      params:
        key_id: ${papertrail_key_id}
        secret_key: ${papertrail_secret_key}
        product: "test-terraform-provider-mongodbatlas"
        version: ${release_version}
        filenames:
          - "src/github.com/mongodb/terraform-provider-mongodbatlas/bin/*"

tasks:
  - name: trace_artifacts
    # tags: [ "trace-artifacts" ] ???
    commands:
      - func: "trace artifacts"
  - name: say_hello2
    commands:
      - command: shell.exec
        params:
          script: |
            echo "Hello world 2 from the papertrail test task! - papertrail.yml"
            
buildvariants:
  - name: tfreleaser_papertrail_test
    display_name: "tfreleaser_papertrail_test"
    run_on:
      - rhel90-small
    expansions:
      <<: *go_linux_version
      server_version: "4.4.0-rc3"
      package_name: "terraform-provider-mongodbatlas"
      # meta_package_name: "mongodb-atlas"
      latest_deb: ~latest
      latest_rpm: .latest
      unstable: -unstable
      version:
    tasks:
      - name: say_hello2
      - name: trace_artifacts
      
