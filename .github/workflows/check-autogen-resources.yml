name: 'Check auto-generated resource code is aligned with serialized models'

# Ensures that the auto-generated resources are up to date given current serialized models.
on:
  push:
    branches:
      - master
    paths:
      - tools/codegen/**
      - internal/serviceapi/**
  pull_request:
    paths:
      - tools/codegen/**
      - internal/serviceapi/**
  workflow_dispatch:

jobs:
  check-autogen-resource-code:
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      - uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417
        with:
          go-version-file: 'go.mod'
      # Checks all generated code is aligned with serialized models, as internal and prod resource changes can be merged independently we cannot ensure that in master all models will be aligned with the commited API Spec
      - run: make tools autogen-generate-resources step=code-gen
      - name: Find mutations
        id: self_mutation
        run: |-
          git add .
          git diff --staged --patch --exit-code > resource.repo.patch || echo "self_mutation_happened=true" >> "${GITHUB_OUTPUT}"
      - name: Fail build on mutation
        if: steps.self_mutation.outputs.self_mutation_happened
        run: |-
          echo "::error::Files were changed during build (see build log). If this was triggered from a fork, you will need to update your branch."
          cat resource.repo.patch
          exit 1
