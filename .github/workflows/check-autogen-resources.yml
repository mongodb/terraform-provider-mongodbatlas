name: 'Check auto-generated resources'

# Ensures that the auto-generated resources are up to date given current API Spec and autogen config.
on:
  push:
    branches:
      - master
    paths:
      - tools/codegen/**
      - internal/serviceapi/**
  pull_request:
    paths:
      - tools/codegen/**
      - internal/serviceapi/**
  workflow_dispatch:

jobs:
  check-autogen-resources:
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5
        with:
          go-version-file: 'go.mod'
      - run: make tools resource-code-generation
      - name: Find mutations
        id: self_mutation
        run: |-
          git add .
          git diff --staged --patch --exit-code > resource.repo.patch || echo "self_mutation_happened=true" >> "${GITHUB_OUTPUT}"
      - name: Fail build on mutation
        if: steps.self_mutation.outputs.self_mutation_happened
        run: |-
          echo "::error::Files were changed during build (see build log). If this was triggered from a fork, you will need to update your branch."
          cat resource.repo.patch
          exit 1
