name: "HashiCorp Terraform Compatibility Matrix"
run-name: 'HashiCorp Terraform Compatibility Matrix ${{ inputs.atlas_cloud_env }}'

on:
  # Will be spread in multiple days in CLOUDP-353513, don't schedule at the moment.
  # schedule:
  #  - cron: "0 0 1 * *" # runs first day of the month at midnight UTC
  workflow_dispatch:
    inputs:
      atlas_cloud_env:
        description: 'Atlas cloud environment used, can be either `dev` or `qa`, empty for `dev`. Migration tests will always use `dev`'     
        type: string
        required: false
      test_group:
        description: 'Test group to run, e.g. advanced_cluster, empty for all'
        type: string
        required: false

jobs:
  get-supported-versions:
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      - name: Get HashiCorp Terraform supported versions
        shell: bash
        id: get-terraform-supported-versions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          output=$(./scripts/get-terraform-supported-versions.sh "false")
          quoted_output=$(echo "${output}" | jq -c .)
          echo "supported_versions=${quoted_output}" >> "${GITHUB_OUTPUT}"
    outputs:
      supported_versions: ${{ steps.get-terraform-supported-versions.outputs.supported_versions }}

          
  run-test-supported-versions:
    needs: ["get-supported-versions"]
    if: ${{ !cancelled() }}
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        terraform_version: '${{ fromJSON(needs.get-supported-versions.outputs.supported_versions) }}'
    name: terrafrom-compatibility-${{ matrix.terraform_version }}-${{ inputs.atlas_cloud_env || 'dev' }}
    secrets: inherit
    uses: ./.github/workflows/test-suite.yml
    with:
      terraform_matrix: '["${{ matrix.terraform_version }}"]'
      atlas_cloud_env: ${{ inputs.atlas_cloud_env || 'dev' }}
      send_notification: false
  
  slack-notification:
    needs: ["run-test-supported-versions"]
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - name: Send Slack message
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL_TEST }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "${{ github.event.repository.name }}: HashiCorp Terraform Compatibility Matrix ${{ needs.run-test-supported-versions.result }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ needs.run-test-supported-versions.result == 'success' && 'âœ…' || 'ðŸ”´' }} *${{ github.event.repository.name }}: HashiCorp Terraform Compatibility Matrix ${{ needs.run-test-supported-versions.result }}* ${{ needs.run-test-supported-versions.result != 'success' && secrets.SLACK_ONCALL_TAG || '' }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": ":github: ${{ needs.run-test-supported-versions.result == 'success' && 'Successful action' || 'Failed action' }}"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        
  
